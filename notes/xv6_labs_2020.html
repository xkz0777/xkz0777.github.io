<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>xv6 labs 2020 笔记 | xkz's blog</title>
    <meta name="description" content="my new Blog using vitrepress">
    <link rel="preload stylesheet" href="/assets/style.538f8502.css" as="style">
    <script type="module" src="/assets/app.5327faf8.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.e802ca17.js">
  <link rel="modulepreload" href="/assets/chunks/theme.b77addca.js">
  <link rel="modulepreload" href="/assets/notes_xv6_labs_2020.md.d2033987.lean.js">
  <link rel="icon" href="/images/icon.jpg">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-f564c5b1><!--[--><!--]--><!--[--><span tabindex="-1" data-v-2c1a443e></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-2c1a443e> Skip to content </a><!--]--><!----><header class="VPNav" data-v-f564c5b1 data-v-4c6103ec><div class="VPNavBar has-sidebar" data-v-4c6103ec data-v-e48442ef><div class="container" data-v-e48442ef><div class="title" data-v-e48442ef><div class="VPNavBarTitle has-sidebar" data-v-e48442ef data-v-5f350234><a class="title" href="/" data-v-5f350234><!--[--><!--]--><!----><!--[-->xkz&#39;s blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-e48442ef><div class="curtain" data-v-e48442ef></div><div class="content-body" data-v-e48442ef><!--[--><!--]--><div class="VPNavBarSearch search" data-v-e48442ef><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><span class="DocSearch-Button-Key">Meta</span><span class="DocSearch-Button-Key">K</span></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-e48442ef data-v-05b2f98f><span id="main-nav-aria-label" class="visually-hidden" data-v-05b2f98f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-05b2f98f data-v-bbd5ab63 data-v-5e5d9dd8><!--[-->Homepage<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/notes/" tabindex="0" data-v-05b2f98f data-v-bbd5ab63 data-v-5e5d9dd8><!--[-->Notes<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/env_config/" tabindex="0" data-v-05b2f98f data-v-bbd5ab63 data-v-5e5d9dd8><!--[-->Environment<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/about/" tabindex="0" data-v-05b2f98f data-v-bbd5ab63 data-v-5e5d9dd8><!--[-->About<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/friends/" tabindex="0" data-v-05b2f98f data-v-bbd5ab63 data-v-5e5d9dd8><!--[-->Friends<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-e48442ef data-v-4bf5620c><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-4bf5620c data-v-7ff9eb8f data-v-df47b6b1><span class="check" data-v-df47b6b1><span class="icon" data-v-df47b6b1><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7ff9eb8f><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7ff9eb8f><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-e48442ef data-v-e6d086f4 data-v-5a940b27><!--[--><a class="VPSocialLink" href="https://github.com/xkz0777/Blogs" aria-label="github" target="_blank" rel="noopener" data-v-5a940b27 data-v-8e9e75b5><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-e48442ef data-v-c76ba7ad data-v-f0bbd558><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-f0bbd558><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-f0bbd558><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-f0bbd558><div class="VPMenu" data-v-f0bbd558 data-v-0a6d52aa><!----><!--[--><!--[--><!----><div class="group" data-v-c76ba7ad><div class="item appearance" data-v-c76ba7ad><p class="label" data-v-c76ba7ad>Appearance</p><div class="appearance-action" data-v-c76ba7ad><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c76ba7ad data-v-7ff9eb8f data-v-df47b6b1><span class="check" data-v-df47b6b1><span class="icon" data-v-df47b6b1><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7ff9eb8f><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7ff9eb8f><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-c76ba7ad><div class="item social-links" data-v-c76ba7ad><div class="VPSocialLinks social-links-list" data-v-c76ba7ad data-v-5a940b27><!--[--><a class="VPSocialLink" href="https://github.com/xkz0777/Blogs" aria-label="github" target="_blank" rel="noopener" data-v-5a940b27 data-v-8e9e75b5><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-e48442ef data-v-b45ebaa7><span class="container" data-v-b45ebaa7><span class="top" data-v-b45ebaa7></span><span class="middle" data-v-b45ebaa7></span><span class="bottom" data-v-b45ebaa7></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-f564c5b1 data-v-e4527d31><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-e4527d31><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-e4527d31><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-e4527d31>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-e4527d31 data-v-70829fbf><button data-v-70829fbf>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-f564c5b1 data-v-eb37f177><div class="curtain" data-v-eb37f177></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-eb37f177><span class="visually-hidden" id="sidebar-aria-label" data-v-eb37f177> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-eb37f177><section class="VPSidebarItem level-0 has-active" data-v-eb37f177 data-v-d4ed8fd1><div class="item" role="button" tabindex="0" data-v-d4ed8fd1><div class="indicator" data-v-d4ed8fd1></div><h2 class="text" data-v-d4ed8fd1>学习笔记</h2><!----></div><div class="items" data-v-d4ed8fd1><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d4ed8fd1 data-v-d4ed8fd1><div class="item" data-v-d4ed8fd1><div class="indicator" data-v-d4ed8fd1></div><a class="VPLink link link" href="/notes/make.html" data-v-d4ed8fd1 data-v-5e5d9dd8><!--[--><p class="text" data-v-d4ed8fd1>Make 和 CMake 的使用</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d4ed8fd1 data-v-d4ed8fd1><div class="item" data-v-d4ed8fd1><div class="indicator" data-v-d4ed8fd1></div><a class="VPLink link link" href="/notes/cs61a.html" data-v-d4ed8fd1 data-v-5e5d9dd8><!--[--><p class="text" data-v-d4ed8fd1>CS61A 学习笔记</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-d4ed8fd1 data-v-d4ed8fd1><div class="item" data-v-d4ed8fd1><div class="indicator" data-v-d4ed8fd1></div><a class="VPLink link link" href="/notes/xv6_labs_2020.html" data-v-d4ed8fd1 data-v-5e5d9dd8><!--[--><p class="text" data-v-d4ed8fd1>6.S081 2020 实验笔记</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-f564c5b1 data-v-280685f9><div class="VPDoc has-sidebar has-aside" data-v-280685f9 data-v-448eb589><!--[--><!--]--><div class="container" data-v-448eb589><div class="aside" data-v-448eb589><div class="aside-curtain" data-v-448eb589></div><div class="aside-container" data-v-448eb589><div class="aside-content" data-v-448eb589><div class="VPDocAside" data-v-448eb589 data-v-42c95bc4><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-42c95bc4 data-v-b4580550><div class="content" data-v-b4580550><div class="outline-marker" data-v-b4580550></div><div class="outline-title" data-v-b4580550>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-b4580550><span class="visually-hidden" id="doc-outline-aria-label" data-v-b4580550> Table of Contents for current page </span><ul class="root" data-v-b4580550 data-v-f808d1ac><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-42c95bc4></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-448eb589><div class="content-container" data-v-448eb589><!--[--><!--]--><!----><main class="main" data-v-448eb589><div style="position:relative;" class="vp-doc _notes_xv6_labs_2020" data-v-448eb589><div><h1 id="xv6-labs-2020-笔记" tabindex="-1">xv6 labs 2020 笔记 <a class="header-anchor" href="#xv6-labs-2020-笔记" aria-label="Permalink to &quot;xv6 labs 2020 笔记&quot;">​</a></h1><h2 id="lab-util" tabindex="-1">Lab Util <a class="header-anchor" href="#lab-util" aria-label="Permalink to &quot;Lab Util&quot;">​</a></h2><p>这个实验主要就是调 syscall 来写用户态程序，所有程序后面都要 <code>exit(0)</code> 来返回到 shell。</p><p>除了 <code>primes</code> 都比较简单，只讲 <code>primes</code>。</p><p>根据 <a href="https://swtch.com/~rsc/thread/sieve.gif" target="_blank" rel="noreferrer">示意图</a>，思路应该是主进程把所有数都发到下一个进程，之后每个进程判断输入是否只有一个，如果不是就再 <code>fork</code> 新进程，把筛过的数继续往后发。</p><p>主函数：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">];</span></span>
<span class="line"><span style="color:#61AFEF;">Pipe</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> pid </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (pid </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">primes</span><span style="color:#ABB2BF;">(fd);</span></span>
<span class="line"><span style="color:#ABB2BF;">} </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> i </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">; i </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">36</span><span style="color:#ABB2BF;">; </span><span style="color:#C678DD;">++</span><span style="color:#ABB2BF;">i) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">write</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">], </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">i, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">wait</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">NULL</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>接下来编写每个进程的行为 <code>primes</code>，按照上面的描述，容易想到使用递归来解决，因为迭代不知道要进行多少次循环，会带来困难。</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">primes</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">int</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">*</span><span style="color:#E06C75;font-style:italic;">fd</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span><span style="color:#7F848E;font-style:italic;"> // 父进程已经用了 fd 的写端口，这里 fd 只用来读</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> prime </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span><span style="color:#7F848E;font-style:italic;"> // 第一个读到的一定是质数，之后读到的，如果不是这个数的倍数，发往下一个进程</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">], </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">prime, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">fprintf</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;prime </span><span style="color:#D19A66;">%d</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, prime);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> p </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">], </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">p, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span><span style="color:#7F848E;font-style:italic;"> // 没有下一个数，不需要再创建子进程，递归终止</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">exit</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">new_fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">];</span><span style="color:#7F848E;font-style:italic;"> // new_fd 用来给子进程传</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">Pipe</span><span style="color:#ABB2BF;">(new_fd);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> pid </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">fork</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (pid </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#61AFEF;">primes</span><span style="color:#ABB2BF;">(new_fd);</span></span>
<span class="line"><span style="color:#ABB2BF;">        } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">new_fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#C678DD;">while</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (p </span><span style="color:#C678DD;">%</span><span style="color:#ABB2BF;"> prime </span><span style="color:#C678DD;">!=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">                    </span><span style="color:#61AFEF;">write</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">new_fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">], </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">p, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#ABB2BF;">                </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">read</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">], </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">p, </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span><span style="color:#7F848E;font-style:italic;"> // 从父进程读完，可以结束</span></span>
<span class="line"><span style="color:#ABB2BF;">                    </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">                    </span><span style="color:#61AFEF;">close</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">new_fd</span><span style="color:#ABB2BF;">[</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">]);</span></span>
<span class="line"><span style="color:#ABB2BF;">                    </span><span style="color:#61AFEF;">wait</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">NULL</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">                    </span><span style="color:#61AFEF;">exit</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">                }</span></span>
<span class="line"><span style="color:#ABB2BF;">            }</span></span>
<span class="line"><span style="color:#ABB2BF;">        }</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>这里还需要注意，因为 <code>int</code> 是四字节，代码里的 <code>prime</code> 和 <code>p</code> 都要初始化。也可以改成读或者写四字节，或者使用 <code>char</code> 代替 <code>int</code> 来避免错误。</p><h2 id="lab-syscall" tabindex="-1">Lab Syscall <a class="header-anchor" href="#lab-syscall" aria-label="Permalink to &quot;Lab Syscall&quot;">​</a></h2><p>本次实验添加两个 syscall，<code>trace</code> 和 <code>sysinfo</code>。</p><p>添加 syscall 的步骤为</p><ol><li><p>到 <code>user/user.h</code> 里添加 syscall 的原型，这里参数和返回值都可以自定义，例如对于 <code>trace</code>，应是接收一个整形参数，标志需要记录的 syscall，执行正常返回 0，否则返回 -1。</p></li><li><p><code>user/usys.pl</code> 里添加对应的 entry，这将使得调用 syscall 时，寄存器 <code>a7</code> 被载入对应 <code>SYS_${name}</code> 的值，然后通过 <code>ecall</code> 调用对应 syscall。</p></li><li><p>在 <code>kernel/syscall.h</code> 里添加对应的 syscall number，也就是 <code>a7</code> 具体被载入的值。</p></li><li><p>在 <code>kernel/sysproc.c</code> 里添加对应的函数，这里的函数一定都没有参数，并且返回值类型为 <code>uint64</code>，其参数根据其类型通过 <code>argint</code>、<code>argaddr</code>、<code>argfd</code> 来获取。</p></li><li><p>在 <code>kernel/syscalls.c</code> 里增加 syscall number 和调用函数的 mapping。</p></li></ol><h3 id="trace" tabindex="-1">Trace <a class="header-anchor" href="#trace" aria-label="Permalink to &quot;Trace&quot;">​</a></h3><p>为了方便 trace 打印 syscall 的名字，在 <code>kernel/syscalls.c</code> 里需要加上 syscall number 到 syscall name 的 mapping。</p><p><code>trace</code> 在当前进程里记录下调用的参数：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#ABB2BF;">uint64 </span><span style="color:#61AFEF;">sys_trace</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> mask;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">argint</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">mask) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">struct</span><span style="color:#ABB2BF;"> proc </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">p </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">myproc</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">mask</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> mask;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>调用 <code>syscall()</code> 时检查当前的 syscall number 和该参数的逻辑与，如果非 0，打印 trace 信息：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">syscall</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> num;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">struct</span><span style="color:#ABB2BF;"> proc </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">p </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">myproc</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    num </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E5C07B;">trapframe</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">a7</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(num </span><span style="color:#C678DD;">&gt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> num </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">NELEM</span><span style="color:#ABB2BF;">(syscalls) </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">syscalls</span><span style="color:#ABB2BF;">[num]) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E5C07B;">trapframe</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">a0</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">syscalls</span><span style="color:#ABB2BF;">[num]();</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> ((</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">mask</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> (</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">&lt;&lt;</span><span style="color:#ABB2BF;"> num)) </span><span style="color:#C678DD;">!=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;</span><span style="color:#D19A66;">%d</span><span style="color:#98C379;">: syscall </span><span style="color:#D19A66;">%s</span><span style="color:#98C379;"> -&gt; </span><span style="color:#D19A66;">%d</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pid</span><span style="color:#ABB2BF;">, </span><span style="color:#E06C75;">syscall_names</span><span style="color:#ABB2BF;">[num], </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E5C07B;">trapframe</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">a0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">    } </span><span style="color:#C678DD;">else</span><span style="color:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;</span><span style="color:#D19A66;">%d</span><span style="color:#98C379;"> </span><span style="color:#D19A66;">%s</span><span style="color:#98C379;">: unknown sys call </span><span style="color:#D19A66;">%d</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pid</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">, num);</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E5C07B;">trapframe</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">a0</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="sysinfo" tabindex="-1">Sysinfo <a class="header-anchor" href="#sysinfo" aria-label="Permalink to &quot;Sysinfo&quot;">​</a></h3><p>获取 <code>struct sysinfo</code> 的对应信息，然后通过 <code>copyout</code> 从内核空间复制到用户空间：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#ABB2BF;">uint64</span></span>
<span class="line"><span style="color:#61AFEF;">sys_sysinfo</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">struct</span><span style="color:#ABB2BF;"> proc </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">p </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">myproc</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">struct</span><span style="color:#ABB2BF;"> sysinfo info;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    uint64 addr;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">argaddr</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">addr) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">info</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">freemem</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">freemem</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">info</span><span style="color:#ABB2BF;">.</span><span style="color:#E06C75;">nproc</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">numproc</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">copyout</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;">, addr, (</span><span style="color:#C678DD;">char</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">)</span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;">info, </span><span style="color:#C678DD;">sizeof</span><span style="color:#ABB2BF;">(info)) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>freemem</code> 在 <code>kernel/kalloc.c</code> 里实现，只要用一个全局计数器记录空页数，每次 <code>kfree</code> 增加一页，<code>kalloc</code> 减少一页，之后乘以每页的大小 <code>PGSIZE</code> 即可。</p><p><code>numproc</code> 在 <code>kernel/proc.c</code> 里实现，最多也就 <code>NPROC</code> 个，遍历整个 <code>proc</code> 数组，不在 <code>UNUSED</code> 状态就算一个。</p><h2 id="lab-pagetable" tabindex="-1">Lab Pagetable <a class="header-anchor" href="#lab-pagetable" aria-label="Permalink to &quot;Lab Pagetable&quot;">​</a></h2><h3 id="print-a-page-table" tabindex="-1">Print a page table <a class="header-anchor" href="#print-a-page-table" aria-label="Permalink to &quot;Print a page table&quot;">​</a></h3><p>仿照 <code>freewalk</code> 即可，可以选择递归，这需要一个 helper function，添加一个参数记录递归层数以在 <code>printf</code> 中缩进。这里因为只有三层，我暴力展开了三重循环：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">vmprint</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">pgtbl</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;page table </span><span style="color:#D19A66;">%p</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, pgtbl);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> i </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">; i </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> PGSIZE </span><span style="color:#C678DD;">/</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">; </span><span style="color:#C678DD;">++</span><span style="color:#ABB2BF;">i) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    uint64 pte1 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">pgtbl</span><span style="color:#ABB2BF;">[i];</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> ((pte1 </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> PTE_V) </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> (pte1 </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> (PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_X)) </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      uint64 pa1 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PTE2PA</span><span style="color:#ABB2BF;">(pte1);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;..</span><span style="color:#D19A66;">%d</span><span style="color:#98C379;">: pte </span><span style="color:#D19A66;">%p</span><span style="color:#98C379;"> pa </span><span style="color:#D19A66;">%p</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, i, pte1, pa1);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> j </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">; j </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> PGSIZE </span><span style="color:#C678DD;">/</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">; </span><span style="color:#C678DD;">++</span><span style="color:#ABB2BF;">j) {</span></span>
<span class="line"><span style="color:#ABB2BF;">        uint64 pte2 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> ((</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#ABB2BF;">)pa1)[j];</span></span>
<span class="line"><span style="color:#ABB2BF;">				</span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> ((pte2 </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> PTE_V) </span><span style="color:#56B6C2;">&amp;&amp;</span><span style="color:#ABB2BF;"> (pte2 </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> (PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_X)) </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">					uint64 pa2 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PTE2PA</span><span style="color:#ABB2BF;">(pte2);</span></span>
<span class="line"><span style="color:#ABB2BF;">					</span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;.. ..</span><span style="color:#D19A66;">%d</span><span style="color:#98C379;">: pte </span><span style="color:#D19A66;">%p</span><span style="color:#98C379;"> pa </span><span style="color:#D19A66;">%p</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, j, pte2, pa2);</span></span>
<span class="line"><span style="color:#ABB2BF;">					</span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (</span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> k </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">; k </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> PGSIZE </span><span style="color:#C678DD;">/</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">8</span><span style="color:#ABB2BF;">; </span><span style="color:#C678DD;">++</span><span style="color:#ABB2BF;">k) {</span></span>
<span class="line"><span style="color:#ABB2BF;">						uint64 pte3 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> ((</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#ABB2BF;">)pa2)[k];</span></span>
<span class="line"><span style="color:#ABB2BF;">						</span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (pte3 </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> PTE_V) {</span></span>
<span class="line"><span style="color:#ABB2BF;">							uint64 pa3 </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PTE2PA</span><span style="color:#ABB2BF;">(pte3);</span></span>
<span class="line"><span style="color:#ABB2BF;">							</span><span style="color:#61AFEF;">printf</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;.. .. ..</span><span style="color:#D19A66;">%d</span><span style="color:#98C379;">: pte </span><span style="color:#D19A66;">%p</span><span style="color:#98C379;"> pa </span><span style="color:#D19A66;">%p</span><span style="color:#56B6C2;">\n</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">, k, pte3, pa3);</span></span>
<span class="line"><span style="color:#ABB2BF;">						}</span></span>
<span class="line"><span style="color:#ABB2BF;">					}</span></span>
<span class="line"><span style="color:#ABB2BF;">				}</span></span>
<span class="line"><span style="color:#ABB2BF;">			}</span></span>
<span class="line"><span style="color:#ABB2BF;">		}</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>注意 <code>PTE2PA</code> 等宏的使用，因为索引是 PPN 加上 12 位 offset（前两层都是 0），并且前两层 <code> pte &amp; (PTE_R | PTE_W | PTE_X)</code> 应该都是 0，最后一层则只要求 Valid。</p><p>下面两问比较困难，一出错就是各种 panic，debug 很痛苦。</p><h3 id="a-kernel-page-table-per-process" tabindex="-1">A kernel page table per process <a class="header-anchor" href="#a-kernel-page-table-per-process" aria-label="Permalink to &quot;A kernel page table per process&quot;">​</a></h3><p>这问主要是为下一问做准备，因为 xv6 原本的实现中只有一个全局内核页表，内核为了解析用户地址，需要传入用户页表，并通过软件模拟页表查询来获取对应的物理地址，例如在 <code>copyin</code> 中，需要通过 <code>walkaddr</code> 在页表中找到对应的物理地址，但如果为每个进程维护对应的 kernel page table，并在进程进入内核时，对应的内核页表被写入 <code>satp</code> 寄存器，硬件就可以完成虚拟地址的解析，并且还能利用 TLB 进行加速查找。</p><p>首先，原本的 <code>kvminit</code> 只要创建一个内核页表，现在抽象出一个函数专门用来创建内核页表：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#56B6C2;">pagetable_t</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kpgtbl_create</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#ABB2BF;"> pagetable </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">vmcreate</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// uart registers</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, UART0, UART0, PGSIZE, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// virtio mmio disk interface</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// PLIC</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, PLIC, PLIC, </span><span style="color:#E06C75;">0x</span><span style="color:#D19A66;">400000</span><span style="color:#ABB2BF;">, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// map kernel text executable and read-only.</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, KERNBASE, KERNBASE, (uint64)etext</span><span style="color:#C678DD;">-</span><span style="color:#ABB2BF;">KERNBASE, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_X);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// map kernel data and the physical RAM we&#39;ll make use of.</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, (uint64)etext, (uint64)etext, PHYSTOP</span><span style="color:#C678DD;">-</span><span style="color:#ABB2BF;">(uint64)etext, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// map the trampoline for trap entry/exit to</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// the highest virtual address in the kernel.</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(pagetable, TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_X);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> pagetable;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这对比 <code>kvminit</code>，少了 <code>CLINT</code> 的 mapping，因为在第三问中，<code>0 ~ PLIC</code> 这一地址空间是给用户页表的，然而 <code>CLINT</code> 比它小，由于这个 mapping 仅在启动时 enable interrupt 有用，因此只添加在 <code>kernel_pagetable</code> 里：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kvminit</span><span style="color:#ABB2BF;">() {</span></span>
<span class="line"><span style="color:#ABB2BF;">  kernel_pagetable </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kpgtbl_create</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(kernel_pagetable, CLINT, CLINT, </span><span style="color:#E06C75;">0x</span><span style="color:#D19A66;">10000</span><span style="color:#ABB2BF;">, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里为 <code>kvmmap</code> 添加了额外的参数，以对不同进程的内核页表添加 mapping。</p><p>然后在 <code>struct proc</code> 里添加一个 <code>kpagetable</code> 域。</p><p>在 <code>allocproc</code> 函数中，为进程分配 <code>kpagetable</code>，此外，因为这个 <code>kpagetable</code> 需要包含这个进程对应内核栈的 mapping，因此原本在 <code>procinit</code> 里统一分配到内核栈也改到 <code>allocproc</code> 分配：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">struct</span><span style="color:#ABB2BF;"> proc</span><span style="color:#C678DD;">*</span></span>
<span class="line"><span style="color:#61AFEF;">allocproc</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">  ...</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// An empty user page table.</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">proc_pagetable</span><span style="color:#ABB2BF;">(p);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">){</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">freeproc</span><span style="color:#ABB2BF;">(p);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">release</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">&amp;</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">lock</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kpgtbl_create</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">char</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">pa </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kalloc</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(pa </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">panic</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;kalloc&quot;</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  uint64 va </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">KSTACK</span><span style="color:#ABB2BF;">((</span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;">)(p </span><span style="color:#C678DD;">-</span><span style="color:#ABB2BF;"> proc));</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kstack</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> va;</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// Each process&#39;s kernel page table has a mapping for that process&#39;s kernel stack</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvmmap</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;">, va, (uint64)pa, PGSIZE, PTE_R </span><span style="color:#C678DD;">|</span><span style="color:#ABB2BF;"> PTE_W);</span></span>
<span class="line"><span style="color:#ABB2BF;">  ...</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这里 <code>va</code> 也可以用 <code>KSTACK(0)</code>，因为每个进程页表里就一个内核栈。</p><p>相应的，<code>freeproc</code> 里要对进程的内核页表和内核栈进行释放。</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">static</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">void</span></span>
<span class="line"><span style="color:#61AFEF;">freeproc</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">struct</span><span style="color:#E06C75;"> proc </span><span style="color:#C678DD;">*</span><span style="color:#E06C75;font-style:italic;">p</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">  ...</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kstack</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    uint64 pa </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kvmpa</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;">, </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kstack</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">kfree</span><span style="color:#ABB2BF;">((</span><span style="color:#C678DD;">void</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">)pa);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">proc_freekpagetable</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kstack</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">  ...</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这里 <code>proc_freekpagetable</code> 和 <code>proc_freepagetable</code> 的区别在于前者不释放三级页表对应的物理空间，那么编写起来和 <code>freewalk</code> 没有区别，只是不需要在发现 leaf 没有被 free 时 panic。</p><p>最后，在调度器 <code>scheduler</code> 里，在进程切换时需要把对应的内核页表写到 <code>satp</code> 寄存器，进程运行结束后再换回 <code>kernel_pagetable</code>：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">state </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> RUNNABLE) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">state</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> RUNNING;</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">c</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">proc</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> p;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">w_satp</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">MAKE_SATP</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">kpagetable</span><span style="color:#ABB2BF;">));</span><span style="color:#7F848E;font-style:italic;"> // 写入 satp，之后 flush TLB</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">sfence_vma</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">swtch</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">&amp;</span><span style="color:#E5C07B;">c</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">context</span><span style="color:#ABB2BF;">, </span><span style="color:#C678DD;">&amp;</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">context</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">c</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">proc</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;">// 换回 kernel_pagetable</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">kvminithart</span><span style="color:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  found </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在写完后运行，发现报错 <code>panic: kvmpa</code>，用 GDB 调试，发现 <code>kvmpa</code> 试图在 <code>kernel_pagetable</code> 里找内核栈的地址。</p><p>于是我想在 <code>allocproc</code> 时把创建的栈也加到 <code>kernel_pagetable</code> 里，这时错误果然已经消失，但是换成了 <code>panic: remap</code>，因为进程会被 free，在用到之前被释放的进程时，它对应的内核栈已经 map 过了，需要在 <code>freeproc</code> 里对应进行 <code>unmap</code>。</p><p>更好的做法是把 <code>kernel/vertio_disk.c</code> 里 <code>disk.desc[idx[0]].addr = (uint64) kvmpa((uint64) &amp;buf0);</code> 改成 <code>disk.desc[idx[0]].addr = (uint64) kvmpa(myproc()-&gt;kpagetable, (uint64) &amp;buf0);</code>（当然要为 <code>kvmpa</code> 添加对应的参数）</p><h3 id="simplify-copyin-copyinstr" tabindex="-1">Simplify copyin/copyinstr <a class="header-anchor" href="#simplify-copyin-copyinstr" aria-label="Permalink to &quot;Simplify copyin/copyinstr&quot;">​</a></h3><p>首先把 <code>copyin</code> 和 <code>copyinstr</code> 改成调用 <code>vmcopy.c</code> 里两个对应的函数：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">copyin</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">char</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">*</span><span style="color:#E06C75;font-style:italic;">dst</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">srcva</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">len</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">copyin_new</span><span style="color:#ABB2BF;">(pagetable, dst, srcva, len);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">copyinstr</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">char</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">*</span><span style="color:#E06C75;font-style:italic;">dst</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">srcva</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">max</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">copyinstr_new</span><span style="color:#ABB2BF;">(pagetable, dst, srcva, max);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>接下来，为了硬件能正确的解析用户地址，需要在每个为用户页表添加 mapping 的地方相应的为内核页表也添加这个 mapping。</p><p>实现一个 <code>kvmcopy</code> 函数，用于向内核页表拷贝用户页表：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">kvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">start</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">end</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  start </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(start);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> (uint64 i </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> start; i </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> end; i </span><span style="color:#C678DD;">+=</span><span style="color:#ABB2BF;"> PGSIZE) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#56B6C2;">pte_t</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">pte </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">walk</span><span style="color:#ABB2BF;">(pagetable, i, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">    uint64 pa </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PTE2PA</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">pte);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> perm </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PTE_FLAGS</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">pte) </span><span style="color:#C678DD;">&amp;</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">~</span><span style="color:#ABB2BF;">PTE_U;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">mappages</span><span style="color:#ABB2BF;">(kpagetable, i, PGSIZE, pa, perm) </span><span style="color:#C678DD;">!=</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#61AFEF;">uvmunmap</span><span style="color:#ABB2BF;">(kpagetable, start, (i </span><span style="color:#C678DD;">-</span><span style="color:#ABB2BF;"> start) </span><span style="color:#C678DD;">/</span><span style="color:#ABB2BF;"> PGSIZE, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这和 <code>uvmcopy</code> 基本类似，但由于 <code>uvmcopy</code> 一定是从地址空间 0 开始拷贝，而 <code>kvmcopy</code> 不一定（后面会讲到），所以要一个 <code>start</code> 参数。此外，<code>uvmcopy</code> 会创建新的物理空间，但 <code>kvmcopy</code> 只要让两个页表的虚拟地址指向相同的物理地址就行了，在权限位需要 clear <code>PTU_U</code> 这一位，否则会导致内核模式下无法访问。</p><p>之后就是在改变用户页表的地方做同步，首先是 <code>fork</code>：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">((</span><span style="color:#61AFEF;">uvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> np</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">sz</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) </span><span style="color:#56B6C2;">||</span></span>
<span class="line"><span style="color:#ABB2BF;">     (</span><span style="color:#61AFEF;">kvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">np</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> np</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">sz</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">)) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">freeproc</span><span style="color:#ABB2BF;">(np);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">release</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">&amp;</span><span style="color:#E5C07B;">np</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">lock</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>exec</code>：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#7F848E;font-style:italic;">// Save program name for debugging.</span></span>
<span class="line"><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;">(last</span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;">s</span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;">path; </span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">s; s</span><span style="color:#C678DD;">++</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(</span><span style="color:#C678DD;">*</span><span style="color:#ABB2BF;">s </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&#39;/&#39;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  last </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> s</span><span style="color:#C678DD;">+</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#61AFEF;">safestrcpy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">name</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> last</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">sizeof</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;">name</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#61AFEF;">uvmunmap</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">oldsz</span><span style="color:#ABB2BF;">)</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">/</span><span style="color:#E06C75;"> PGSIZE</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#61AFEF;">kvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sz</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">// Commit to the user image.</span></span>
<span class="line"><span style="color:#ABB2BF;">oldpagetable </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">pagetable;</span></span>
<span class="line"><span style="color:#ABB2BF;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">pagetable </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> pagetable;</span></span>
<span class="line"><span style="color:#ABB2BF;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">sz </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> sz;</span></span>
<span class="line"><span style="color:#ABB2BF;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">trapframe</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">epc </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> elf.entry;</span><span style="color:#7F848E;font-style:italic;">  // initial program counter = main</span></span>
<span class="line"><span style="color:#ABB2BF;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">trapframe</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">sp </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> sp;</span><span style="color:#7F848E;font-style:italic;"> // initial stack pointer</span></span>
<span class="line"><span style="color:#61AFEF;">proc_freepagetable</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">oldpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> oldsz</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">pid </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">vmprint</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>因为 <code>exec</code> 直接替换进程的地址空间，因此对应的内核页表需要先清空再复制，防止出现 remap 错误。</p><p><code>growproc</code>：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#ABB2BF;">uint64 newsz;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">((newsz </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">uvmalloc</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sz</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sz </span><span style="color:#C678DD;">+</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">)) </span><span style="color:#C678DD;">==</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">kvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sz</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> sz </span><span style="color:#C678DD;">+</span><span style="color:#E06C75;"> n</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">uvmdealloc</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">p</span><span style="color:#ABB2BF;">-&gt;</span><span style="color:#E06C75;">pagetable</span><span style="color:#ABB2BF;">, newsz, sz);</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">-</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">sz </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> newsz;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>需要注意的是，这里不是从 0 开始 copy，而是从旧的 <code>size</code> 处开始，copy 需要 grow 的大小 <code>n</code>。这也是为什么 <code>kvmcopy</code> 需要增加一个参数。</p><p>最后是 <code>userinit</code>：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#61AFEF;">uvminit</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> initcode</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#C678DD;">sizeof</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">initcode</span><span style="color:#ABB2BF;">));</span></span>
<span class="line"><span style="color:#ABB2BF;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#ABB2BF;">sz </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> PGSIZE;</span></span>
<span class="line"><span style="color:#61AFEF;">kvmcopy</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">kpagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> p</span><span style="color:#C678DD;">-&gt;</span><span style="color:#E06C75;font-style:italic;">sz</span><span style="color:#ABB2BF;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此外，因为用户页表还可能会去除一些映射，再新增一个函数 <code>kvmdealloc</code> 在 <code>growproc</code> 里调用：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#ABB2BF;">uint64 </span><span style="color:#61AFEF;">kvmdealloc</span><span style="color:#ABB2BF;">(</span><span style="color:#56B6C2;">pagetable_t</span><span style="color:#E06C75;"> </span><span style="color:#E06C75;font-style:italic;">pagetable</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">oldsz</span><span style="color:#ABB2BF;">,</span><span style="color:#E06C75;"> uint64 </span><span style="color:#E06C75;font-style:italic;">newsz</span><span style="color:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(newsz </span><span style="color:#C678DD;">&gt;=</span><span style="color:#ABB2BF;"> oldsz)</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> oldsz;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(newsz) </span><span style="color:#C678DD;">&lt;</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(oldsz)){</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">int</span><span style="color:#ABB2BF;"> npages </span><span style="color:#C678DD;">=</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(oldsz) </span><span style="color:#C678DD;">-</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(newsz)) </span><span style="color:#C678DD;">/</span><span style="color:#ABB2BF;"> PGSIZE;</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">uvmunmap</span><span style="color:#ABB2BF;">(pagetable, </span><span style="color:#61AFEF;">PGROUNDUP</span><span style="color:#ABB2BF;">(newsz), npages, </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">);</span><span style="color:#7F848E;font-style:italic;"> // 只有这里和 uvm 有区别，并不释放内存</span></span>
<span class="line"><span style="color:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> newsz;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最后，为了防止用户使用的地址超过 <code>PLIC</code>，在 <code>uvmalloc</code> 里添加判断：</p><div class="language-c line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki one-dark-pro"><code><span class="line"><span style="color:#C678DD;">if</span><span style="color:#ABB2BF;"> (</span><span style="color:#61AFEF;">PGROUNDDOWN</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">newsz</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">&gt;=</span><span style="color:#ABB2BF;"> PLIC) {</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">return</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">0</span><span style="color:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="lab-traps" tabindex="-1">Lab Traps <a class="header-anchor" href="#lab-traps" aria-label="Permalink to &quot;Lab Traps&quot;">​</a></h2></div></div></main><footer class="VPDocFooter" data-v-448eb589 data-v-067484fb><!--[--><!--]--><div class="edit-info" data-v-067484fb><!----><div class="last-updated" data-v-067484fb><p class="VPLastUpdated" data-v-067484fb data-v-0e8f9ec5>Last updated: <time datetime="2023-05-24T07:40:38.000Z" data-v-0e8f9ec5></time></p></div></div><div class="prev-next" data-v-067484fb><div class="pager" data-v-067484fb><a class="pager-link prev" href="/notes/cs61a.html" data-v-067484fb><span class="desc" data-v-067484fb>Previous page</span><span class="title" data-v-067484fb>CS61A 学习笔记</span></a></div><div class="has-prev pager" data-v-067484fb><!----></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"env_config_vscode_gdb.md\":\"c18666aa\",\"about_index.md\":\"4cea7531\",\"index.md\":\"5ad9417d\",\"friends_index.md\":\"ee46a610\",\"env_config_6.s081.md\":\"b687a9d1\",\"env_config_index.md\":\"9a1271c3\",\"env_config_reinstall.md\":\"5f9daa8a\",\"notes_index.md\":\"2b36c33d\",\"notes_xv6_labs_2020.md\":\"d2033987\",\"notes_cs61a.md\":\"25effcf0\",\"notes_make.md\":\"bae508e8\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"xkz's blog\",\"description\":\"my new Blog using vitrepress\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/xkz0777/Blogs\"}],\"nav\":[{\"text\":\"Homepage\",\"link\":\"/\"},{\"text\":\"Notes\",\"link\":\"/notes/\"},{\"text\":\"Environment\",\"link\":\"/env_config/\"},{\"text\":\"About\",\"link\":\"/about/\"},{\"text\":\"Friends\",\"link\":\"/friends/\"}],\"sidebar\":{\"/homepage\":[{\"text\":\"主页\",\"items\":[{\"text\":\"Hello world\",\"link\":\"/index.md\"}]}],\"/notes\":[{\"text\":\"学习笔记\",\"items\":[{\"text\":\"Make 和 CMake 的使用\",\"link\":\"/notes/make.md\"},{\"text\":\"CS61A 学习笔记\",\"link\":\"/notes/cs61a.md\"},{\"text\":\"6.S081 2020 实验笔记\",\"link\":\"/notes/xv6_labs_2020.md\"}]}],\"/env_config\":[{\"text\":\"配环境记录\",\"items\":[{\"text\":\"vscode 使用 GDB 调试\",\"link\":\"/env_config/vscode_gdb.md\"},{\"text\":\"记一次重装系统\",\"link\":\"/env_config/reinstall.md\"},{\"text\":\"6.S081 环境配置\",\"link\":\"/env_config/6.s081.md\"}]}]}},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>